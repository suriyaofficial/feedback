import React, { useEffect, useMemo, useState } from "react";
import { BrowserRouter as Router, Routes, Route, useParams, Navigate } from "react-router-dom";

// ----- Helpers -----
function safeDecodeBase64Url(input) {
  if (!input) return null;
  try {
    // Some encoders use URL-safe base64 ("-" and "_" instead of "+" and "/")
    const normalized = input.replace(/-/g, "+").replace(/_/g, "/");
    // Add padding if missing
    const pad = normalized.length % 4 === 2 ? "==" : normalized.length % 4 === 3 ? "=" : "";
    const b64 = normalized + pad;
    const text = atob(decodeURIComponent(b64));
    return JSON.parse(text);
  } catch (e) {
    try {
      // Fallback for already-base64 string with "=" padding
      const text = atob(input);
      return JSON.parse(text);
    } catch (err) {
      console.error("Failed to decode base64 payload", err);
      return null;
    }
  }
}

// ----- UI bits -----
function Card({ children }) {
  return (
    <div className="max-w-md w-full mx-auto mt-10 rounded-2xl shadow-lg border p-6 space-y-4 bg-white">
      {children}
    </div>
  );
}

function StarRating({ value, onChange, max = 5 }) {
  return (
    <div className="flex gap-2 justify-center">
      {Array.from({ length: max }, (_, i) => i + 1).map((n) => (
        <button
          key={n}
          type="button"
          title={`${n} star${n > 1 ? "s" : ""}`}
          onClick={() => onChange(n)}
          className="text-3xl focus:outline-none"
          aria-pressed={value >= n}
        >
          <span>{value >= n ? "★" : "☆"}</span>
        </button>
      ))}
    </div>
  );
}

function ThanksScreen({ businessName }) {
  return (
    <Card>
      <div className="text-center space-y-3">
        <h2 className="text-2xl font-semibold">Thanks for your feedback!</h2>
        {businessName && (
          <p className="text-gray-600">We appreciate you taking the time to rate {businessName}.</p>
        )}
      </div>
    </Card>
  );
}

// ----- Feedback Page -----
function FeedbackPage() {
  const { payload } = useParams();
  const [business, setBusiness] = useState(null);
  const [rating, setRating] = useState(0);
  const [comment, setComment] = useState("");
  const [submitted, setSubmitted] = useState(false);

  const decoded = useMemo(() => safeDecodeBase64Url(payload || ""), [payload]);

  useEffect(() => {
    let active = true;

    async function fetchBusinessById(businessId) {
      try {
        // Replace with your real API endpoint
        const res = await fetch(`/api/business/${businessId}`);
        if (!res.ok) throw new Error("Failed to fetch business");
        const data = await res.json();
        if (!active) return;
        // Expecting an object with keys that mirror decoded payload
        setBusiness({
          businessId: data.businessId ?? businessId,
          businessName: data.businessName ?? decoded?.businessName,
          placeId: data.placeId ?? decoded?.placeId,
          sliderDesign: data.sliderDesign ?? decoded?.sliderDesign ?? "star",
          tagLine: data.tagLine ?? decoded?.tagLine ?? "",
          warningRatingThreshold: Number(data.warningRatingThreshold ?? decoded?.warningRatingThreshold ?? 3),
          emailNotifier: data.emailNotifier ?? decoded?.emailNotifier,
          url: data.url ?? window.location.href,
        });
      } catch (err) {
        // Fallback to using the decoded payload directly
        if (!active) return;
        if (decoded) {
          setBusiness({
            businessId: decoded.businessId,
            businessName: decoded.businessName,
            placeId: decoded.placeId,
            sliderDesign: decoded.sliderDesign || "star",
            tagLine: decoded.tagLine || "",
            warningRatingThreshold: Number(decoded.warningRatingThreshold ?? 3),
            emailNotifier: decoded.emailNotifier,
            url: window.location.href,
          });
        }
      }
    }

    if (decoded?.businessId) fetchBusinessById(decoded.businessId);

    return () => {
      active = false;
    };
  }, [decoded]);

  async function handleSubmit(e) {
    e.preventDefault();
    if (!business) return;

    const payload = {
      businessId: business.businessId,
      rating,
      comment,
      ts: new Date().toISOString(),
      sourceUrl: window.location.href,
    };

    try {
      // Replace with your real API endpoint
      await fetch(`/api/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (err) {
      // You could show a toast/snackbar; we'll continue the flow regardless
      console.warn("Feedback submission failed; continuing flow", err);
    }

    setSubmitted(true);

    const threshold = Number(business.warningRatingThreshold ?? 3);
    if (Number.isFinite(threshold) && rating > threshold && business.placeId) {
      // High rating -> push user to Google review
      const url = `https://search.google.com/local/writereview?placeid=${encodeURIComponent(business.placeId)}`;
      window.location.assign(url);
    }
  }

  if (!decoded) {
    return <Navigate to="/" replace />;
  }

  if (submitted && rating <= (business?.warningRatingThreshold ?? 3)) {
    return <ThanksScreen businessName={business?.businessName} />;
  }

  return (
    <Card>
      <div className="space-y-1 text-center">
        <h1 className="text-2xl font-bold">{business?.businessName ?? decoded.businessName ?? "Business"}</h1>
        {(business?.tagLine || decoded?.tagLine) && (
          <p className="text-gray-600">{business?.tagLine ?? decoded?.tagLine}</p>
        )}
      </div>

      <form className="space-y-4" onSubmit={handleSubmit}>
        <div className="space-y-2">
          <label className="block text-sm font-medium text-gray-700">Your rating</label>
          {(business?.sliderDesign ?? decoded?.sliderDesign) === "star" ? (
            <StarRating value={rating} onChange={setRating} />
          ) : (
            <input
              type="range"
              min={1}
              max={5}
              value={rating}
              onChange={(e) => setRating(Number(e.target.value))}
              className="w-full"
            />
          )}
          <p className="text-xs text-gray-500 text-center">Tap to select 1–5</p>
        </div>

        <div className="space-y-2">
          <label className="block text-sm font-medium text-gray-700">Comments (optional)</label>
          <textarea
            value={comment}
            onChange={(e) => setComment(e.target.value)}
            rows={3}
            placeholder="Tell us more..."
            className="w-full border rounded-xl p-3 focus:outline-none focus:ring"
          />
        </div>

        <button
          type="submit"
          disabled={!rating}
          className="w-full rounded-2xl py-3 font-semibold bg-black text-white disabled:opacity-50"
        >
          Submit
        </button>
      </form>

      <div className="text-center text-xs text-gray-400">
        <p>Threshold: {String(business?.warningRatingThreshold ?? decoded?.warningRatingThreshold ?? 3)} • Place ID: {business?.placeId ?? decoded?.placeId ?? "–"}</p>
      </div>
    </Card>
  );
}



